## 🧩 页面一：登录界面（/login）

**功能描述：** 用户输入邮箱或者用户名来搭配密码进行登录

**需要调用的 API：**

#### **用户登录 （已完成）**

- 方法：`POST`

- 路径：`/api/users/login`

- 请求参数：

  - 

  - | **参数名**                                | **类型** | **是否必填** | **示例值**         | **说明**         |
    | ----------------------------------------- | -------- | ------------ | ------------------ | ---------------- |
    | useAccount （可以是 username 或者 email） | String   | 是           | admin或xxx@163.com | 用户名 或者 邮箱 |
    | password                                  | String   | 是           | 12345678           | 密码（明文）     |

**返回示例**

 成功：

```json
{
  "code": 200,
  "data": {
    "user_id": 1,
    "username": "user1",
    "email": "user1@163.com",
    "avatar_url": "",
    "role": "user",
    "created_at": "2025-04-11T17:56:26.000+00:00",
    "updated_at": "2025-04-13T15:50:45.000+00:00"
  },
  "message": "ok"
}
```

 失败（例如账号或密码错误）：

 不能明确指出是账号出错了还是密码出错了，不然可能存在安全问题

```json
{
  "code": 400,
  "data": null,
  "message": "Incorrect input of account/email or password"
}
```

**注意事项**

- 密码字段（`password`）不会在返回结果中提供，保证信息安全。

#### **获取当前登录用户信息（已完成）**

- 方法：`GET`
- 路径：`/api/users/me`

**返回示例**

 成功：

```json
{
  "code": 200,
  "data": {
    "user_id": 1,
    "username": "user1",
    "email": "user1@163.com",
    "avatar_url": "http://sulthbbxs.hd-bkt.clouddn.com/avatars/users/default.jpg",
    "role": "user",
    "created_at": "2025-04-11T17:56:26.000+00:00",
    "updated_at": "2025-04-13T15:50:45.000+00:00"
  },
  "message": "ok"
}
```

 失败（）：

```json
{
  "code": 400,
  "msg": "Access denied",
  "data": null
}
```

**注意事项**

- 必须在请求头中携带正确格式的 Token（`Authorization: Bearer <token>`），否则服务器返回 401 错误。
- 返回的用户信息包括 id、username、role 和 token。
- 当前接口通常在前端页面初始化时调用，用于判断当前用户是否已登录以及确认身份和权限信息。
- 如果 Token 无效或已过期，前端应引导用户重新登录。

## 🧩 页面二：注册界面（/register）

**功能描述：** 新用户输入邮箱、密码、学号等进行注册，后端保存账号并发送激活邮件。

**需要调用的 API：**

#### **用户注册 （已完成）**

- 方法：`POST`
- 路径：`/api/users/register`
- 请求参数：

| **参数名** | **类型**     | **必填** | **示例**                                                     | **说明**                                   |
| ---------- | ------------ | -------- | ------------------------------------------------------------ | ------------------------------------------ |
| username   | String       | 是       | san.zhang                                                    | 用户名                                     |
| email      | String       | 是       | [san.zhang22@student.xjtlu.edu.cn](mailto:san.zhang22@student.xjtlu.edu.cn) | 用户注册时所提供的邮箱                     |
| password   | String       | 是       | 12345678                                                     | 密码（明文）；长度不少于8位                |
| code       | String       | 是       | 123456                                                       | 用户输入的验证码                           |
| role       | String       | 是       | admin 或 user                                                | 角色类型（区分管理员和普通用户）           |
| file       | MultpartFile | 否       | -                                                            | 可填可不填，如果没有指定的话，就是默认头像 |

**返回示例**

 成功：

```json
{
  "code": 200,
  "data": {
    "user_id": 4,
    "username": "user",
    "email": "hjh814315762@163.com",
    "avatar_url": null,
    "role": "user",
    "created_at": "2025-04-17T23:37:28",
    "updated_at": "2025-04-17T23:37:28"
  },
  "message": "ok"
}
```

 失败：

```json
{
  "code": 400,
  "data": null,
  "message": "The username has been registered."
}
```

**注意事项**

- 在注册之前，后端必须校验邮箱是否已存在，防止数据库因唯一约束冲突而出错。

#### **邮箱验证（我直接在注册请求的时候在后端对这部分实现了）**

- 方法：`POST`

- 路径：`/api/users/``verify-email`

- 请求参数：

  - | **参数名** | **类型** | **必填** | **示例值**                                                   | **说明**                                         |
    | ---------- | -------- | -------- | ------------------------------------------------------------ | ------------------------------------------------ |
    | email      | String   | 是       | [san.zhang22@student.xjtlu.edu.cn](mailto:san.zhang22@student.xjtlu.edu.cn) | 用户填写的邮箱地址，需要验证格式并检查是否已注册 |

**返回示例**

 成功：

```json
{
  "code": 200,
  "msg": "Success",
  "data": null
}
```

 失败：

```json
{
  "code": 5009,
  "msg": "Email already registered",
  "data": null
}
```

**注意事项**

- 验证成功后，应将对应用户的账户状态设置为已激活。
- 验证失败时，前端应提示用户重新注册。
- 验证完成后，前端可跳转到登录页，提示“激活成功，请登录”。

## 🧩 页面三：找回密码界面（/reset-password）

**功能描述：** 用户忘记密码时，可以通过邮箱请求验证码，验证验证码后设置新密码。

**需要调用的 API：**

#### 发送验证码 （已完成）

- 方法：`GET`

- 路径：`/api/users/ask_code`

- 请求参数：

  - | **参数名** | **类型** | **必填** | **示例值**                                                   | **说明**                                         |
    | ---------- | -------- | -------- | ------------------------------------------------------------ | ------------------------------------------------ |
    | email      | String   | 是       | [san.zhang22@student.xjtlu.edu.cn](mailto:san.zhang22@student.xjtlu.edu.cn) | 用户填写的邮箱地址，需要验证格式并检查是否已注册 |

**返回示例**

 成功：

```json
{
  "code": 200,
  "data": {
    "user_id": 2,
    "username": "test_admin",
    "email": "admin@teacher.xjtlu.edu.cn",
    "avatar_url": "/avatars/default.jpg",
    "role": "admin",
    "created_at": "2025-04-16T17:36:04",
    "updated_at": "2025-04-17T19:10:11"
  },
  "message": "ok"
}
```

 失败：

```json
{
  "code": 400,
  "data": null,
  "message": "username/email or password is incorrect"
}
```

**注意事项**

- 后端应验证传入的邮箱格式是否合法，防止非法参数。
- 后端在发送邮件前需要检查邮箱是否存在于系统中。
- 如果邮箱未注册，可以统一返回提示信息，避免暴露系统中已注册的用户信息（防止被恶意探测）。
- 发送的邮件应包含一个有时效性的验证码。

#### **重置密码 （已完成）**

- 方法：`POST`

- 路径：`/api/users/reset-password`

- 请求参数：

  - | **参数名**  | **类型** | **必填** | **示例值**     | **说明**                           |
    | ----------- | -------- | -------- | -------------- | ---------------------------------- |
    | code        | String   | 是       | 114514         | 验证码（通常是发送到邮箱的验证码） |
    | newPassword | String   | 是       | newpassword123 | 新密码（用户希望重置的新密码）     |
    | email       | String   | 是       | admin@163.com  | 修改密码用户用来接受验证码的邮箱   |

**返回示例**

 成功：

```json
{
  "code": 200,
  "msg": "Password Reset Success",
  "data": null
}
```

 失败（例如 token 无效或已过期）：

```json
{
  "code": 501,
  "msg": "Failed to change the password",
  "data": null
}
```

**注意事项**

- 前端页面需要校验新密码的输入规则（例如长度不少于6位，包含字母数字等）。
- 后端收到请求后，应验证验证码的有效性（是否正确和是否过期）
- 重置密码后，旧的验证码应立即失效，防止被重复使用。
- 重置成功后，应提示用户使用新密码重新登录。
- 新密码不能和旧密码一致

## 🧩 页面四：用户个人主页（/profile）

**功能描述：** 用户查看和编辑自己的个人信息，包括用户名、头像、密码等设置。为了简洁，所有操作集中在一个页面，不再单独拆分“设置”页。在这里需要鉴定执行这些操作的请求是不是来自用户本身，可以通过session来鉴定。

**需要调用的 API：**

#### **获取当前用户信息 （已完成）**

- 方法：`GET`
- 路径：`/api/users/me`
- 请求头：Authorization

**返回示例**

 成功：

```json
{
  "code": 200,
  "msg": "Success",
  "data": {
    "id": 2251668,
    "username": "san.zhang",
    "email": "san.zhang22@student.xjtlu.edu.cn",
    "role": "USER",
    "avatarUrl": "https://yourapp-avatar.qiniu.com/default-avatar.jpg"
  }
}
```

 失败：

```json
{
  "code": 400,
  "msg": "No user has been found",
  "data": null
}
```

**注意事项**

- 返回的信息只包括当前登录用户的基本信息，不包含敏感数据（如密码）。
- 如果请求中的 user 为空，应提示用户重新登录。

#### **修改用户名 （已完成）**

- 方法：`POST`

- 路径：`/api/users/change-``username`

- 请求参数：

  - | **参数名**  | **类型** | **是否必填** | **示例**  | **说明**                                       |
    | ----------- | -------- | ------------ | --------- | ---------------------------------------------- |
    | oldUsername | String   | 是           | San.Zhang | 用户更改之前的用户名，用来传回后端进行身份校验 |
    | newUsername | String   | 是           | Li.Si     | 新的用户名，不能为空，不可与现有用户名重复。   |

- 请求头：Authorization

**返回示例**

 成功：

```json
{
  "code": 200,
  "data": {
    "user_id": 4,
    "username": "user1",
    "email": "gustavhuang@126.com",
    "avatar_url": "/avatars/4_1744909024664.jpg",
    "role": "user",
    "created_at": "2025-04-17T23:37:28",
    "updated_at": "2025-04-18T00:57:04"
  },
  "message": "ok"
}
```

 失败：

```JSON
{
  "code": 400,
  "data": null,
  "message": "You are not allowed to change the username"
}
```

**注意事项**

- 前端后端都应该对于字符串进行检验，具体规则后面再讨论。
- 返回的信息只包括当前登录用户的基本信息，不包含敏感数据（如密码）。

#### **修改密码**（和重置密码是一套api）（已完成）**

- 方法：`POST`

- 路径：`/api/users/reset-password`

- 请求参数：

  - | **参数名**  | **类型** | **是否必填** | **示例值**        | **说明**                           |
    | ----------- | -------- | ------------ | ----------------- | ---------------------------------- |
    | code        | String   | 是           | 114514            | 验证码（通常是发送到邮箱的验证码） |
    | newPassword | String   | 是           | new_password_here | 用户希望设置的新密码               |
    | email       | String   | 是           | xxx@qq.com63.com  | 修改密码的用户的邮箱               |

**返回示例**

 成功：

```json
{
  "code": 200,
  "data": "Password Reset Success",
  "message": "ok"
}
```

 失败（例如原密码错误或 token 无效）：

```json
{
  "code": 5011,
  "msg": "Original password incorrect",
  "data": null
}
```

**注意事项**

- 前端后端都应该对密码进行基本格式校验，例如长度（不少于8位）、复杂度（字母+数字），具体规则后面再讨论。
- 修改密码时必须提供正确的原密码，防止非法用户直接修改。
- 后端在存储密码时必须进行加密（例如使用bcrypt哈希）。
- 只有当前登录的用户或者管理员可以更改其密码。
- 返回的信息中不得包含任何敏感数据（如密码明文或哈希值）。

#### **上传头像 （已完成）**

- 方法：`POST`

- 路径：`/api/qiniu/upload-avatar`

- 请求参数：这里要求的请求形式是 formData

  - | **参数名** | **类型**           | **是否必填** | **示例**     | **说明**                                                    |
    | ---------- | ------------------ | ------------ | ------------ | ----------------------------------------------------------- |
    | file       | File（二进制文件） | 是           | 头像图片文件 | 上传的图片文件，格式支持 .jpg、.png、jepg，大小限制 2MB以内 |

**返回示例**

 成功：

```json
{
  "code": 200,
  "data": {
    "avatar_url": "http://sulthbbxs.hd-bkt.clouddn.com/avatars/4_1744909024664.jpg"
  },
  "message": "ok"
}
```

 失败（例如原密码错误或 token 无效）：

```JSON
{
  "code": 400,
  "data": null,
  "message": "Wrong user id"
}
```

**注意事项**

- 前端上传头像时，应限制图片大小不超过2MB，格式仅限"jpeg", "png", "jpg", "webp", "JPG", "WEBP", "PNG", "JPEG"。
- 后端应校验上传文件的类型和大小，防止恶意文件上传。
- 上传成功后，返回头像的公网访问URL，供前端更新用户头像展示。
- 只允许当前登录用户上传自己的头像，后端必须校验 `userId` 与请求中 session 的用户ID一致。

#### **修改邮箱** **（已完成）**

- 方法：`POST`

- 路径：`/api/users/change-email`

- 请求参数：

  - | **参数名** | **类型** | **是否必填** | **示例**                                                     | **说明**                                           |
    | ---------- | -------- | ------------ | ------------------------------------------------------------ | -------------------------------------------------- |
    | oldEmail   | String   | 是           | oldEmail@student.xjtlu.edu.cn                                | 用户在更改之前的邮箱地址，需要传回后端用来身份校验 |
    | newEmail   | String   | 是           | si.li[22@student.xjtlu.edu.cn](mailto:san.zhang22@student.xjtlu.edu.cn) | 用户填写的邮箱地址，需要验证格式并检查是否已注册   |

**返回示例**

 成功：

```json
{
  "code": 200,
  "msg": "Success",
  "data": null
```

 失败（例如原密码错误或 token 无效）：

```JSON
{
  "code": 500,
  "msg": "Wrong email format",
  "data": null
```

**注意事项**

- 后端应校验新邮箱地址的格式，确保符合标准邮箱格式。
- 后端应检查新邮箱地址是否已经被其他用户注册，避免重复注册。
- 修改邮箱操作需要用户保持登录状态。
- 后端应请求，并解析出的用户未更改之前的邮箱，确保是当前用户本人或者管理员在修改自己的邮箱。
- 如果用户请求中没有携带登录状态的 session_id，应提示用户重新登录。
- 修改成功后，应更新数据库中的用户邮箱字段，并返回成功响应。
- 若邮箱格式错误、邮箱已存在，或 Token 无效，应返回明确的错误信息提示前端处理。

#### **注销账户 （已完成）**

- 方法：`POST`
- 路径：`/api/users/delete`

**返回示例**

 成功：

```json
{
  "code": 200,
  "msg": "Success",
  "data": null
}
```

 失败（例如原密码错误或 token 无效）：

```json
{
  "code": 500,
  "msg": "Access denied",
  "data": null
}
```

**注意事项**

- 注销账户操作需用户确认（建议前端弹窗二次确认）。
- 后端必须校验当前登录用户身份，只允许本人注销自己的账户。
- 注销后，用户账户状态应变为 "注销/禁用"，或逻辑删除，避免直接物理删除数据。

#### 注销登录 （已完成）

 方法：`GET`

 路径：`/api/users/logout`

返回示例:

成功：

```JSON
{
  "code": 200,
  "msg": "Success",
  "data": null
}
```

失败：

```JSON
{
  "code": 500,
  "msg": "Access denied",
  "data": null
}
```

- 用户需要当前是登录状态才能申请注销登录
- 注销登录之后，需要删除存放在本地缓存当中的验证码